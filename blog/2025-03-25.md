# OpenGL Perspective Projection Matrix
*Tuesday, March 25, 2025*

## The Equation For a Finite Viewing Frustum
Given the following definitions for the 3D viewing frustum:
- $\varphi$, the vertical field of view, in radians
- $\rho$, the aspect ratio of the viewport, equal to width/height
- $z_N$, the z-value of the near clipping plane
- $z_F$, the z-value of the far clipping plane

We can write the perpsective transformation $T : [x_W \; y_W \; z_W \; 1]^\top \mapsto [x_C \; y_C \; z_C \; w_C]^\top$ which maps each world space vector onto its corresonding clip space vector as follows:
$$
\begin{equation}
\begin{bmatrix}
x_C \\
y_C \\
z_C \\
w_C \\
\end{bmatrix}
=
\begin{bmatrix}
\displaystyle \frac{1}{\rho} \cot\left(\displaystyle \frac{\varphi}{2}\right) & 0 & 0 & 0 \\
0 & \cot\left(\displaystyle \frac{\varphi}{2}\right) & 0 & 0 \\
0 & 0 & \displaystyle \frac{z_N + z_F}{z_N - z_F} & \displaystyle \frac{2 z_N z_F}{z_N - z_F} \\
0 & 0 & -1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
x_W \\
y_W \\
z_W \\
1
\end{bmatrix}
\end{equation}
$$
Note that most programming libraries have a tangent function instead of a cotangent. We could use the identity:
$$
\begin{equation}
\cot(\theta) = \displaystyle \frac{1}{\tan(\theta)}
\end{equation}
$$
However, there could be a performance penalty from using repeated floating-point divisions. Instead, we can use the following:
$$
\begin{equation}
\cot(\theta) = \tan\left(\displaystyle \frac{\pi}{2} - \theta\right)
\end{equation} 
$$
Even though we still see fractions here, we can actually eliminate floating-point divisions further because any number divided by 2 is the same as that number multiplied by 0.5.

We can now rewrite the transformation as:
$$
\begin{equation}
\begin{bmatrix}
x_C \\
y_C \\
z_C \\
w_C \\
\end{bmatrix}
=
\begin{bmatrix}
\displaystyle \frac{1}{\rho} \tan\left(\displaystyle \frac{\pi}{2} - \displaystyle \frac{\varphi}{2}\right) & 0 & 0 & 0 \\
0 & \tan\left(\displaystyle \frac{\pi}{2} - \displaystyle \frac{\varphi}{2}\right) & 0 & 0 \\
0 & 0 & \displaystyle \frac{z_N + z_F}{z_N - z_F} & \displaystyle \frac{2 z_N z_F}{z_N - z_F} \\
0 & 0 & -1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
x_W \\
y_W \\
z_W \\
1
\end{bmatrix}
\end{equation}
$$

## The Equation For an Infinitely Long Viewing Frustum
We could also set the z-value of the far clipping plane to infinity, meaning that we'll need to recompute the two cells of the matrix containing $z_F$:
$$
\begin{equation}
\begin{align*}
\lim_{z_F \rightarrow \infty} \displaystyle \frac{z_N + z_F}{z_N - z_F} &= -1 \\
\lim_{z_F \rightarrow \infty} \displaystyle \frac{2 z_N z_F}{z_N - z_{F}} &= -2 z_N
\end{align*}
\end{equation}
$$

This gives us a new transformation equation:
$$
\begin{equation}
\begin{bmatrix}
x_C \\
y_C \\
z_C \\
w_C \\
\end{bmatrix}
=
\begin{bmatrix}
\displaystyle \frac{1}{\rho} \tan\left(\displaystyle \frac{\pi}{2} - \displaystyle \frac{\varphi}{2}\right) & 0 & 0 & 0 \\
0 & \tan\left(\displaystyle \frac{\pi}{2} - \displaystyle \frac{\varphi}{2}\right) & 0 & 0 \\
0 & 0 & -1 & -2 z_N \\
0 & 0 & -1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
x_W \\
y_W \\
z_W \\
1
\end{bmatrix}
\end{equation}
$$

## OpenGL/WebGL Functions
The equations above correspond to the glMatrix [`mat4.perspective`](https://glmatrix.net/docs/mat4.js.html) function for WebGL.
See also the implementation for [`glm::perspective`](https://github.com/g-truc/glm/blob/0.9.5/glm/gtc/matrix_transform.inl) from the GLM library for modern OpenGL as well as the [`gluPerspective`](https://registry.khronos.org/OpenGL-Refpages/gl2.1/xhtml/gluPerspective.xml) function from the GLU library for legacy OpenGL.
